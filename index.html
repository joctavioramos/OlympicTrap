<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>FO ‚Äî Ronda 25 (velocidad + heatmap 3 filas + impresi√≥n clara)</title>
  <style>
    :root { --bg:#0f172a; --card:#0b1220; --fg:#e5e7eb; --muted:#9aa4b2; --chip:#111827; --shadow:0 10px 30px rgba(0,0,0,.35);
            --g:#22c55e; --y:#facc15; --r:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; background: radial-gradient(1200px 800px at 20% -10%, #1f2937 0%, var(--bg) 50%); color:var(--fg);}
    .container{max-width:1100px;margin:0 auto;padding:16px;}
    .card{background:linear-gradient(180deg,var(--card),#0c1426);border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:var(--shadow);padding:16px;}
    h1{margin:.2rem 0 .1rem;font-size:22px} h2{margin:.2rem 0 10px;font-size:16px;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid rgba(255,255,255,.08);padding:6px 10px;border-radius:999px;font-size:12px}
    button,select{background:#0a0f1d;color:var(--fg);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px 14px;font-size:18px;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#19c37d,#0ea763);border:0;color:#052817;font-weight:800}
    button.warn{background:#1f2937;border-color:#374151}
    button.danger{background:linear-gradient(180deg,#ef4444,#b91c1c);border:0}
    button:disabled{opacity:.45; cursor:not-allowed}
    .grid{display:grid;gap:10px}
    .dirGrid{grid-template-columns:repeat(3,1fr)}
    .velGrid{grid-template-columns: repeat(7, 1fr)}
    .pill{padding:10px 8px;border-radius:12px;border:1px solid rgba(255,255,255,.12);text-align:center;font-weight:800}
    .active{outline:2px solid #3b82f6}
    .small{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;font-size:14px} th,td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    thead th{position:sticky;top:0;background:#0b1220}
    .summary{margin-top:12px;padding:18px;border-radius:14px;background:#050a16;border:2px solid #334155;display:none}
    .summary.show{display:block}
    .sum-grid{display:grid;grid-template-columns: repeat(4, 1fr); gap:14px}
    .sum-card{background:#0b162c;border:1px solid #2a3a55;border-radius:12px;padding:14px;text-align:center}
    .sum-label{font-size:14px;color:#a7b4c6;letter-spacing:.3px}
    .sum-value{font-size:28px;font-weight:900;letter-spacing:.3px}
    .sum-score{color:#22d3ee} .sum-first{color:var(--g)} .sum-second{color:var(--y)} .sum-missed{color:var(--r)}
    .heat-wrap{margin-top:12px;background:#050a16;border:1px solid #2a3a55;border-radius:14px;padding:12px}
    #heat{width:100%;height:160px}
    .chart-wrap{margin-top:12px;background:#050a16;border:1px solid #2a3a55;border-radius:14px;padding:12px}
    #chart{width:100%;height:360px}
    .legend{display:flex;gap:12px;align-items:center}
    .lgdot{width:12px;height:12px;border-radius:50%}
    .g{background:var(--g)} .y{background:var(--y)} .r{background:var(--r)}

    /* Result buttons bigger + colored */
    .resBtns { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn-res { padding: 16px 18px; font-size: 22px; font-weight: 900; border-radius: 14px; border: 0; cursor: pointer; }
    .btn-res:disabled{ opacity:.6; cursor:not-allowed }
    .btn-res.res0 { background: var(--r); color: #0b0b0b; }
    .btn-res.res1 { background: var(--g); color: #0b0b0b; }
    .btn-res.res2 { background: var(--y); color: #0b0b0b; }

    .no-print{}
    /* PRINT (white) */
    @media print{

      .print-header{ display:block !important }

      @page { size: A4 portrait; margin: 12mm; }
      body{background:#fff;color:#111}
      .no-print{display:none !important}
      .card{border:0; box-shadow:none; background:#fff; padding:0}
      .summary{display:block !important; background:#fff; border:0; padding:0}
      .sum-card{border:1px solid #ccc; background:#fff}
      .heat-wrap,.chart-wrap{border:0; background:#fff; padding:0}
      .sum-label{color:#444}
      canvas{background:#fff}
    }
  
    /* --- PRINT: Letter landscape single page, white background --- */
    @media print{

      .print-header{ display:block !important }

      @page { size: Letter landscape; margin: 8mm; }
      html, body { width: 279.4mm; height: 215.9mm; background:#fff; color:#111; }
      /* Oculta controles de captura y deja solo el resumen */
      .no-print, .dirGrid, .velGrid, #r0, #r1, #r2, .card.no-print { display:none !important; }
      /* Asegura que el bloque de resumen siempre est√© visible */
      #summary { display:block !important; background:#fff; border:0; padding:0; }
      .sum-card{ border:1px solid #ccc; background:#fff }
      .heat-wrap,.chart-wrap{ border:0; background:#fff; padding:0; }
      .sum-grid{ gap:8px }
      .sum-value{ font-size:24px }
      /* Compactar alturas para caber en una sola hoja */
      #heat{ height:120px !important; background:#fff }
      #chart{ height:220px !important; background:#fff }
      /* Si existe heatmap de tiempo-resultado, compactarlo tambi√©n */
      #heatVR{ height:170px !important; background:#fff }
    }

  
    /* --- Summary block in LIGHT theme (screen) --- */
    #summary { background:#fff !important; color:#111 !important; border:1px solid #ccc !important; }
    #summary .sum-card { background:#fff !important; border:1px solid #ddd !important; }
    #summary .heat-wrap, #summary .heat2-wrap, #summary .chart-wrap { background:#fff !important; border:1px solid #e5e7eb !important; }
    #summary canvas { background:#fff !important; }

  
/* Show print header in print mode */
@media print{
  .print-header{ display:block !important }
}

  </style>
</head>
<body>
  <div class="container">
    <div class="row no-print" style="justify-content:space-between;align-items:baseline">
      <h1>FO ‚Äî Ronda de 25 (velocidad + heatmap 3 filas + impresi√≥n clara)</h1>
      <div class="row">
        <span class="chip" id="roundInfo">Sin ronda</span>
        <button id="btnHelp">Ayuda</button>
      </div>
    </div>

    <div class="card no-print">
      <h2>1) Esquema y Posici√≥n de inicio</h2>
      <div class="row">
        <label>Esquema</label>
        <select id="esquemaSel"></select>
        <label>Posici√≥n inicial</label>
        <select id="startPos">
          <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
        </select>
        <button id="btnNew" class="primary">Nueva ronda (25)</button>
        <button id="btnEnd">Terminar</button>
        <button id="btnUndo" class="warn">Deshacer</button>
      </div>
      <p class="small">L√≠mites por posici√≥n: <b>Izq=2</b>, <b>Cen=1</b>, <b>Der=2</b>. La posici√≥n avanza sola.</p>
    </div>

    <div id="summary" class="summary">
      <div id="printHeader" class="print-header" style="display:none; text-align:center; margin-bottom:8px; color:#111;">
        <div style="font-weight:800; font-size:20px;">Resumen ‚Äî Ronda <span id="phRonda">#</span> ‚Äî Esquema <span id="phEsquema">?</span></div>
        <div style="font-size:13px; color:#444;">Generado: <span id="phFecha">‚Äî</span></div>
      </div>

      <div class="sum-grid">
        <div class="sum-card"><div class="sum-label">Marcador</div><div id="sumScore" class="sum-value sum-score">0/25</div></div>
        <div class="sum-card"><div class="sum-label">1er disparo</div><div id="sumFirst" class="sum-value sum-first">0</div></div>
        <div class="sum-card"><div class="sum-label">2¬∫ disparo</div><div id="sumSecond" class="sum-value sum-second">0</div></div>
        <div class="sum-card"><div class="sum-label">Fallados</div><div id="sumMiss" class="sum-value sum-missed">0</div></div>
      </div>
      <div class="heat-wrap">
        <div class="row" style="justify-content:space-between">
          <div class="small">Heatmap de la ronda (1..25)</div>
          <div class="legend small">
            <span class="lgdot" style="background:transparent;border:1px solid #94a3b8"></span> 1er ‚Ä¢ 
            <span class="lgdot y"></span> 2¬∫ ‚Ä¢ 
            <span class="lgdot r"></span> Fallo ‚Ä¢ 
            <span class="lgdot g"></span> Vel 0.6‚Äì0.7 ‚Ä¢ 
            <span class="lgdot y"></span> Vel 0.5‚Äì0.8 ‚Ä¢ 
            <span class="lgdot r"></span> Vel 0.4 / 0.9 / 1.0
          </div>
        </div>
        <canvas id="heat"></canvas>
      </div>
      <div class="chart-wrap">
        <div class="row" style="justify-content:space-between">
          <div class="small">Gr√°fica ‚Äî ùë• = √Ångulo (¬∞) / ùë¶ = Altura</div>
          <div class="legend small"><span class="lgdot" style="background:transparent;border:1px solid #94a3b8"></span> 1er ‚Ä¢ <span class="lgdot y"></span> 2¬∫ ‚Ä¢ <span class="lgdot r"></span> Fallo</div>
        </div>
        <canvas id="chart"></canvas>
      </div>
      <div class="row no-print" style="margin-top:10px; justify-content:flex-end">
        <button id="btnPrint" class="primary">Imprimir resumen (PDF)</button>
      </div>
    </div>

    <div class="card no-print" style="margin-top:12px">
      <h2>2) Direcci√≥n, Velocidad y Resultado</h2>
      <div class="grid dirGrid">
        <button class="pill" id="dirIzq">Izq</button>
        <button class="pill" id="dirCen">Cen</button>
        <button class="pill" id="dirDer">Der</button>
      </div>
      <div class="grid velGrid" style="margin-top:8px">
        <button class="pill" data-vel="0.4">0.4</button>
        <button class="pill" data-vel="0.5">0.5</button>
        <button class="pill active" data-vel="0.6">0.6</button>
        <button class="pill" data-vel="0.7">0.7</button>
        <button class="pill" data-vel="0.8">0.8</button>
        <button class="pill" data-vel="0.9">0.9</button>
        <button class="pill" data-vel="1.0">1.0</button>
      </div>
      <div class="row resBtns" style="margin-top:8px">
        <button id="r0" class="btn-res res0">0 ‚Äî Fallo</button>
        <button id="r1" class="btn-res res1">1 ‚Äî 1er disparo</button>
        <button id="r2" class="btn-res res2">2 ‚Äî 2¬∫ disparo</button>
      </div>
      <p class="small">Flujo: <b>Izq/Cen/Der</b> ‚Üí <b>Velocidad</b> ‚Üí <b>0/1/2</b>.</p>
    </div>

    <div class="card no-print" style="margin-top:12px">
      <h2>3) Progreso</h2>
      <div class="small">Esquema: <span id="esquemaActivo">‚Äî</span> ‚Ä¢ Posici√≥n actual: <span id="posActivo">‚Äî</span> ‚Ä¢ Dir actual: <span id="dirActivo">‚Äî</span> ‚Ä¢ Velocidad: <span id="velActivo">‚Äî</span> ‚Ä¢ Disparo #: <span id="shotNo">0</span> / <span id="shotTot">25</span></div>
      <div style="max-height:340px;overflow:auto;margin-top:6px">
        <table>
          <thead><tr><th>#</th><th>Pos</th><th>Dir</th><th>Vel</th><th>M√°q</th><th>Resultado</th><th>√Ångulo1</th><th>Altura</th><th>√Ångulo</th><th>Direcci√≥n</th></tr></thead>
          <tbody id="shotsBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card no-print" style="margin-top:12px">
      <h2>4) Exportar</h2>
      <div class="row">
        <button id="btnCsvSimple" class="primary">Exportar SIMPLE (Ronda,Esquema,No.Maquina,Resultado,Vel)</button>
        <button id="btnCsvDet">Exportar DETALLADO</button>
        <button id="btnClearAll" class="danger">Borrar TODO</button>
      </div>
    </div>
  </div>

  <script>
  const SCHEMAS_CSV = `Codigo,Esquema,Posicion,Maquina,Angulo1,Altura,Angulo,Direccion
1.01,1,1,1,25,2.00,25,R
1.02,1,1,2,-5,3.00,5,L
1.03,1,1,3,-35,1.50,35,L
1.04,1,2,4,45,2.50,45,R
1.05,1,2,5,10,1.80,10,R
1.06,1,2,6,-35,3.00,35,L
1.07,1,3,7,35,3.00,35,R
1.08,1,3,8,-5,1.50,5,L
1.09,1,3,9,-45,1.60,45,L
1.1,1,4,10,40,1.50,40,R
1.11,1,4,11,0,3.00,0,C
1.12,1,4,12,-25,2.60,25,L
1.13,1,5,13,20,2.40,20,R
1.14,1,5,14,5,1.90,5,R
1.15,1,5,15,-35,3.00,35,L
2.01,2,1,1,25,3.00,25,R
2.02,2,1,2,-5,1.80,5,L
2.03,2,1,3,-35,2.00,35,L
2.04,2,2,4,40,2.00,40,R
2.05,2,2,5,0,3.00,0,C
2.06,2,2,6,-45,1.60,45,L
2.07,2,3,7,45,1.50,45,R
2.08,2,3,8,0,2.80,0,C
2.09,2,3,9,-40,2.00,40,L
2.1,2,4,10,15,1.50,15,R
2.11,2,4,11,5,2.00,5,R
2.12,2,4,12,-35,1.80,35,L
2.13,2,5,13,35,1.80,35,R
2.14,2,5,14,-5,1.50,5,L
2.15,2,5,15,-40,3.00,40,L
3.01,3,1,1,30,2.50,30,R
3.02,3,1,2,0,2.80,0,C
3.03,3,1,3,-35,3.00,35,L
3.04,3,2,4,45,1.50,45,R
3.05,3,2,5,-5,2.50,5,L
3.06,3,2,6,-40,1.70,40,L
3.07,3,3,7,30,2.80,30,R
3.08,3,3,8,5,3.00,5,R
3.09,3,3,9,-45,1.50,45,L
3.1,3,4,10,45,2.30,45,R
3.11,3,4,11,0,3.00,0,C
3.12,3,4,12,-40,1.60,40,L
3.13,3,5,13,30,2.00,30,R
3.14,3,5,14,0,1.50,0,C
3.15,3,5,15,-35,2.20,35,L
4.01,4,1,1,40,3.00,40,R
4.02,4,1,2,10,1.50,10,R
4.03,4,1,3,-30,2.20,30,L
4.04,4,2,4,30,1.60,30,R
4.05,4,2,5,-10,3.00,10,L
4.06,4,2,6,-35,2.00,35,L
4.07,4,3,7,45,2.00,45,R
4.08,4,3,8,0,3.00,0,C
4.09,4,3,9,-20,1.50,20,L
4.1,4,4,10,30,1.50,30,R
4.11,4,4,11,-5,2.00,5,L
4.12,4,4,12,-45,2.80,45,L
4.13,4,5,13,35,2.50,35,R
4.14,4,5,14,0,1.60,0,C
4.15,4,5,15,-30,3.00,30,L
5.01,5,1,1,45,1.60,45,R
5.02,5,1,2,0,3.00,0,C
5.03,5,1,3,-15,2.00,15,L
5.04,5,2,4,40,2.80,40,R
5.05,5,2,5,-10,1.50,10,L
5.06,5,2,6,-45,2.00,45,L
5.07,5,3,7,35,3.00,35,R
5.08,5,3,8,-5,1.80,5,L
5.09,5,3,9,-40,1.50,40,L
5.1,5,4,10,25,1.80,25,R
5.11,5,4,11,0,1.60,0,C
5.12,5,4,12,-30,3.00,30,L
5.13,5,5,13,30,2.00,30,R
5.14,5,5,14,10,2.40,10,R
5.15,5,5,15,-15,1.80,15,L
6.01,6,1,1,40,2.00,40,R
6.02,6,1,2,0,3.00,0,C
6.03,6,1,3,-35,1.50,35,L
6.04,6,2,4,35,2.50,35,R
6.05,6,2,5,10,1.50,10,R
6.06,6,2,6,-35,2.00,35,L
6.07,6,3,7,35,2.00,35,R
6.08,6,3,8,-5,1.50,5,L
6.09,6,3,9,-40,3.00,40,L
6.1,6,4,10,45,1.50,45,R
6.11,6,4,11,-10,3.00,10,L
6.12,6,4,12,-25,2.60,25,L
6.13,6,5,13,25,2.40,25,R
6.14,6,5,14,5,1.50,5,R
6.15,6,5,15,-45,2.00,45,L
7.01,7,1,1,35,2.20,35,R
7.02,7,1,2,-5,3.00,5,L
7.03,7,1,3,-20,3.00,20,L
7.04,7,2,4,40,2.00,40,R
7.05,7,2,5,0,3.00,0,C
7.06,7,2,6,-45,2.80,45,L
7.07,7,3,7,40,3.00,40,R
7.08,7,3,8,0,2.00,0,C
7.09,7,3,9,-40,2.20,40,L
7.1,7,4,10,45,1.50,45,R
7.11,7,4,11,5,2.00,5,R
7.12,7,4,12,-35,1.80,35,L
7.13,7,5,13,20,1.80,20,R
7.14,7,5,14,-5,1.50,5,L
7.15,7,5,15,-45,2.00,45,L
8.01,8,1,1,25,3.00,25,R
8.02,8,1,2,5,1.50,5,R
8.03,8,1,3,-20,2.00,20,L
8.04,8,2,4,40,1.50,40,R
8.05,8,2,5,0,3.00,0,C
8.06,8,2,6,-45,2.80,45,L
8.07,8,3,7,35,3.00,35,R
8.08,8,3,8,-5,2.50,5,L
8.09,8,3,9,-45,2.00,45,L
8.1,8,4,10,45,1.80,45,R
8.11,8,4,11,0,1.50,0,C
8.12,8,4,12,-30,3.00,30,L
8.13,8,5,13,30,2.00,30,R
8.14,8,5,14,10,3.00,10,R
8.15,8,5,15,-15,2.20,15,L
9.01,9,1,1,40,3.00,40,R
9.02,9,1,2,0,1.80,0,C
9.03,9,1,3,-20,3.00,20,L
9.04,9,2,4,15,3.00,15,R
9.05,9,2,5,-10,1.50,10,L
9.06,9,2,6,-35,2.00,35,L
9.07,9,3,7,45,1.60,45,R
9.08,9,3,8,0,2.80,0,C
9.09,9,3,9,-30,3.00,30,L
9.1,9,4,10,30,2.00,30,R
9.11,9,4,11,-5,2.00,5,L
9.12,9,4,12,-15,3.00,15,L
9.13,9,5,13,35,2.90,35,R
9.14,9,5,14,0,1.60,0,C
9.15,9,5,15,-45,2.20,45,L`;

  function parseSchemas(csv){
    const lines = csv.trim().split(/\r?\n/); const header = lines.shift().split(',').map(s=>s.trim()); const idx=(n)=>header.indexOf(n);
    const bySchema=new Map(), esquemas=new Set();
    for (const line of lines){
      const c=line.split(',').map(s=>s.trim());
      const esquema=Number(c[idx('Esquema')]); const pos=Number(c[idx('Posicion')]); const machine=Number(c[idx('Maquina')]);
      const meta={ pos, machine, angulo1:Number(c[idx('Angulo1')]), altura:Number(c[idx('Altura')]), angulo:Number(c[idx('Angulo')]), direccion:c[idx('Direccion')] };
      if(!bySchema.has(esquema)) bySchema.set(esquema,{machines:{},posMap:new Map()});
      const e=bySchema.get(esquema); e.machines[machine]=meta; if(!e.posMap.has(pos)) e.posMap.set(pos,[]); e.posMap.get(pos).push(machine); esquemas.add(esquema);
    }
    for (const e of bySchema.values()){ for (const [p,arr] of e.posMap.entries()) arr.sort((a,b)=>a-b); }
    return { bySchema, esquemas:[...esquemas].sort((a,b)=>a-b) };
  }
  const schemas=parseSchemas(SCHEMAS_CSV);

  // Estado
  const storageKey='fo_ronda25_velocity_print_v1'; const roundsKey='fo_round_counter';
  const LIMITS={Izq:2,Cen:1,Der:2};
  const state={ current:null, rounds:[] };
  (function load(){ try{ const raw=localStorage.getItem(storageKey); if(raw){ const d=JSON.parse(raw); state.rounds=d.rounds||[]; } }catch{} })();
  function save(){ localStorage.setItem(storageKey, JSON.stringify({ rounds: state.rounds })); }
  function nextRoundNumber(){ const n=Number(localStorage.getItem(roundsKey)||'0')+1; localStorage.setItem(roundsKey,String(n)); return n; }
  function newCounts(){ return {1:{Izq:0,Cen:0,Der:0},2:{Izq:0,Cen:0,Der:0},3:{Izq:0,Cen:0,Der:0},4:{Izq:0,Cen:0,Der:0},5:{Izq:0,Cen:0,Der:0}}; }

  // UI refs
  const esquemaSel=document.getElementById('esquemaSel'); const startPosSel=document.getElementById('startPos');
  const shotsBody=document.getElementById('shotsBody'); const esquemaActivo=document.getElementById('esquemaActivo');
  const posActivo=document.getElementById('posActivo'); const dirActivo=document.getElementById('dirActivo');
  const velActivo=document.getElementById('velActivo');
  const shotNoSpan=document.getElementById('shotNo'); const roundInfo=document.getElementById('roundInfo');
  const dirBtn={ Izq:document.getElementById('dirIzq'), Cen:document.getElementById('dirCen'), Der:document.getElementById('dirDer') };
  const velBtns=[...document.querySelectorAll('.velGrid [data-vel]')];
  const summary=document.getElementById('summary'); const sumScore=document.getElementById('sumScore'); const sumFirst=document.getElementById('sumFirst'); const sumSecond=document.getElementById('sumSecond'); const sumMiss=document.getElementById('sumMiss');
  const chart=document.getElementById('chart'); const heat=document.getElementById('heat'); let ctxC=null, ctxH=null;

  // Populate esquema options
  schemas.esquemas.forEach(e=>{ const o=document.createElement('option'); o.value=e; o.textContent='Esquema '+e; esquemaSel.appendChild(o); });

  // Direction selection
  let selectedDir='Izq'; let selectedVel='0.6';
  function selectDir(d){ selectedDir=d; dirActivo.textContent=d; for(const k of Object.keys(dirBtn)){ dirBtn[k].classList.toggle('active', k===d); } }
  function selectVel(v){ selectedVel=v; velActivo.textContent=v; velBtns.forEach(b=>b.classList.toggle('active', b.dataset.vel===v)); }

  velBtns.forEach(b=> b.onclick=()=>selectVel(b.dataset.vel));

  function inferMachine(esquema,pos,dir){ const e=schemas.bySchema.get(esquema); if(!e) return null; const trio=e.posMap.get(pos)||[]; const idx=dir==='Izq'?0:(dir==='Cen'?1:2); return trio[idx]??null; }

  function updateDirButtons(){
    const cur=state.current;
    if(!cur){ for(const k of Object.keys(dirBtn)){ dirBtn[k].disabled=true; dirBtn[k].classList.remove('active'); } return; }
    const pos=cur.pos;
    dirBtn.Izq.disabled = cur.counts[pos].Izq >= LIMITS.Izq;
    dirBtn.Cen.disabled = cur.counts[pos].Cen >= LIMITS.Cen;
    dirBtn.Der.disabled = cur.counts[pos].Der >= LIMITS.Der;
    if (dirBtn[selectedDir].disabled){
      const next = !dirBtn.Izq.disabled ? 'Izq' : (!dirBtn.Cen.disabled ? 'Cen' : (!dirBtn.Der.disabled ? 'Der' : null));
      if (next) selectDir(next);
    }
  }

  function renderShots(){
    shotsBody.innerHTML=''; if(!state.current) return; const esquema=state.current.esquema;
    state.current.shots.forEach((s,idx)=>{
      const meta=(schemas.bySchema.get(esquema)?.machines||{})[s.machine]||{};
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${idx+1}</td><td>${s.pos}</td><td>${s.dir}</td><td>${s.vel}</td><td>${s.machine}</td><td>${s.result}</td>
        <td>${meta.angulo1??''}</td><td>${meta.altura??''}</td><td>${meta.angulo??''}</td><td>${meta.direccion??''}</td>`;
      shotsBody.appendChild(tr);
    });
    posActivo.textContent=state.current.pos; dirActivo.textContent=selectedDir; velActivo.textContent=selectedVel; shotNoSpan.textContent=String(state.current.shots.length+1);
  }

  function computeSummary(shots){ let first=0,second=0,missed=0; for(const s of shots){ if(s.result===1) first++; else if(s.result===2) second++; else missed++; } return {first,second,missed,score:first+second}; }

  function startRound(){
    const esquema=Number(esquemaSel && esquemaSel.value ? esquemaSel.value : 1); const startPos=Number(startPosSel.value); const number=nextRoundNumber();
    state.current={ id:String(Date.now()), number, esquema, size:25, pos:startPos, shots:[], counts:newCounts() };
    esquemaActivo.textContent=esquema; posActivo.textContent=startPos; shotNoSpan.textContent='1'; roundInfo.textContent='Ronda #'+number;
    for(const k of Object.keys(dirBtn)){ dirBtn[k].disabled=false; } selectDir('Izq'); selectVel('0.6');
    summary.classList.remove('show');
    if (typeof selectVel === 'function') { selectVel('0.6'); }
    renderShots(); updateDirButtons();
  }

  function endRound(show=true){
    if(!state.current) return;
    if(show){
      const s=computeSummary(state.current.shots);
      sumScore.textContent=`${s.score}/25`; sumFirst.textContent=String(s.first); sumSecond.textContent=String(s.second); sumMiss.textContent=String(s.missed);
      summary.classList.add('show'); drawHeat(state.current); drawChart(state.current);
    }
    state.rounds.push(state.current); save(); state.current=null; esquemaActivo.textContent='‚Äî'; posActivo.textContent='‚Äî'; dirActivo.textContent='‚Äî'; velActivo.textContent='‚Äî'; shotNoSpan.textContent='0'; shotsBody.innerHTML=''; roundInfo.textContent='Sin ronda';
    updateDirButtons();
  }

  function undo(){ if(!state.current||state.current.shots.length===0) return; const last=state.current.shots.pop(); state.current.pos=last.pos; if(state.current.counts[last.pos][last.dir]>0) state.current.counts[last.pos][last.dir]-=1; if (typeof selectVel === 'function') { selectVel('0.6'); }
    renderShots(); updateDirButtons(); }

  function addShot(result){
    if(!state.current){ alert('Inicia una ronda.'); return; }
    if(state.current.shots.length>=25) return;
    const pos=state.current.pos; const dir=selectedDir; const used=state.current.counts[pos][dir]; const limit=LIMITS[dir];
    if(used>=limit) return;
    const m=inferMachine(state.current.esquema,pos,dir); if(!m){ alert('No se pudo inferir la m√°quina'); return; }
    state.current.shots.push({ pos, dir, vel:selectedVel, machine:m, result, ts:Date.now() }); state.current.counts[pos][dir]+=1; state.current.pos=(pos%5)+1;
    if (typeof selectVel === 'function') { selectVel('0.6'); }
    renderShots(); updateDirButtons();
    if(state.current.shots.length===25) endRound(true);
  }

  // Heatmap: row1 1..25 header, row2 result (1 transparent, 2 yellow, 0 red), row3 velocity (G 0.6/0.7, Y 0.5/0.8, R 0.4/0.9/1.0+)
  function drawHeat(round){
    if(!ctxH){ ctxH=heat.getContext('2d'); }
    const w=heat.width=heat.clientWidth*2, h=heat.height=heat.clientHeight*2; ctxH.setTransform(1,0,0,1,0,0);
    ctxH.clearRect(0,0,w,h);
    const cols=25; const cellW=(w-180)/cols; const cellH=40; const x0=10, yHeader=10, yRow1= yHeader + cellH + 10, yRow2 = yRow1 + cellH + 8;
    // colors from CSS vars
    const styles=getComputedStyle(document.documentElement);
    const COL_Y=styles.getPropertyValue('--y').trim();
    const COL_R=styles.getPropertyValue('--r').trim();
    const COL_G=styles.getPropertyValue('--g').trim();

    ctxH.lineWidth=3; ctxH.strokeStyle='#cbd5e1'; ctxH.fillStyle='#cbd5e1'; ctxH.font='bold 26px system-ui';
    // header
    for(let i=0;i<cols;i++){
      const x=x0+i*cellW; ctxH.strokeRect(x,yHeader,cellW,cellH);
      const label=String(i+1); const tw=ctxH.measureText(label).width; ctxH.fillText(label, x + cellW/2 - tw/2, yHeader + cellH/2 + 9);
    }
    const totX = x0 + cols*cellW + 10; const totW=150;
    ctxH.strokeRect(totX, yHeader, totW, cellH);
    const twt=ctxH.measureText('TOTAL').width; ctxH.fillText('TOTAL', totX + totW/2 - twt/2, yHeader + cellH/2 + 9);

    // results row
    for(let i=0;i<cols;i++){
      const x=x0+i*cellW; ctxH.strokeRect(x,yRow1,cellW,cellH);
      const shot=round.shots[i]; if(!shot) continue;
      if (shot.result===2){ ctxH.fillStyle=COL_Y; ctxH.fillRect(x+2,yRow1+2,cellW-4,cellH-4); }
      else if (shot.result===0){ ctxH.fillStyle=COL_R; ctxH.fillRect(x+2,yRow1+2,cellW-4,cellH-4); }
      ctxH.fillStyle=(shot.result===0||shot.result===2)?'#111827':'#cbd5e1';
      ctxH.font='bold 28px system-ui';
      const txt = shot.result===0 ? '0' : String(shot.result);
      const tw=ctxH.measureText(txt).width; ctxH.fillText(txt, x + cellW/2 - tw/2, yRow1 + cellH/2 + 10);
    }

    // velocity row
    for(let i=0;i<cols;i++){
      const x=x0+i*cellW; ctxH.strokeRect(x,yRow2,cellW,cellH);
      const shot=round.shots[i]; if(!shot) continue;
      const v=shot.vel;
      let col=null;
      if (v==='0.6' || v==='0.7') col=COL_G;
      else if (v==='0.5' || v==='0.8') col=COL_Y;
      else if (v==='0.4' || v==='0.9' || v==='1.0+') col=COL_R;
      if (col){ ctxH.fillStyle=col; ctxH.fillRect(x+2,yRow2+2,cellW-4,cellH-4); }
      ctxH.fillStyle=(col? '#111827':'#cbd5e1'); ctxH.font='bold 24px system-ui';
      const txt = v; const tw=ctxH.measureText(txt).width; ctxH.fillText(txt, x + cellW/2 - tw/2, yRow2 + cellH/2 + 8);
    }

    // total
    const score = round.shots.reduce((s,a)=> s + (a.result>0?1:0), 0);
    ctxH.fillStyle='#cbd5e1'; ctxH.font='bold 32px system-ui';
    const tscore=String(score); const tw2=ctxH.measureText(tscore).width;
    ctxH.fillText(tscore, totX + totW/2 - tw2/2, yRow1 + cellH/2 + 12);
    ctxH.strokeStyle='#cbd5e1'; ctxH.strokeRect(totX, yRow1, totW, cellH);
  }

  // Scatter chart with jitter ¬±0.2¬∞ and ¬±0.03 height (center no jitter)
  function drawChart(round){
    if(!ctxC){ ctxC=chart.getContext('2d'); }
    const e=schemas.bySchema.get(round.esquema); const metas=e.machines;
    const occurrences=new Map();
    const pts=round.shots.map((s)=>{
      const m=metas[s.machine]||{}; const key=s.pos+'|'+s.dir; const k=occurrences.get(key)||0; occurrences.set(key,k+1);
      let dx=0, dy=0; if(s.dir==='Cen'){ dx=0; dy=0; } else { dx=(k===0?-0.2:+0.2); dy=(k===0?-0.03:+0.03); }
      return { x:(m.angulo1??0)+dx, y:(m.altura??0)+dy, r:s.result };
    });
    const w=chart.width=chart.clientWidth*2, h=chart.height=chart.clientHeight*2; ctxC.setTransform(1,0,0,1,0,0); ctxC.clearRect(0,0,w,h);
    const xs=pts.map(p=>p.x); const ys=pts.map(p=>p.y);
    const xmin=Math.min(-50,(xs.length?Math.min(...xs): -50))-2, xmax=Math.max(50,(xs.length?Math.max(...xs): 50))+2;
    const ymin=Math.min(1.0,(ys.length?Math.min(...ys): 1.0))-0.1, ymax=Math.max(3.5,(ys.length?Math.max(...ys): 3.5))+0.1;
    const pl=70, pr=25, pt=20, pb=60;
    const X=(val)=> pl + (val - xmin) * (w - pl - pr) / (xmax - xmin);
    const Y=(val)=> h - pb - (val - ymin) * (h - pt - pb) / (ymax - ymin);
    // grid
    ctxC.strokeStyle='rgba(255,255,255,0.10)'; ctxC.lineWidth=2;
    for(let gx=Math.ceil(xmin/10)*10; gx<=xmax; gx+=10){ const x=X(gx); ctxC.beginPath(); ctxC.moveTo(x, Y(ymin)); ctxC.lineTo(x, Y(ymax)); ctxC.stroke(); }
    for(let gy=Math.ceil(ymin*2)/2; gy<=ymax; gy+=0.5){ const y=Y(gy); ctxC.beginPath(); ctxC.moveTo(X(xmin), y); ctxC.lineTo(X(xmax), y); ctxC.stroke(); }
    // axes
    ctxC.strokeStyle='#6b7280'; ctxC.lineWidth=3;
    ctxC.beginPath(); ctxC.moveTo(X(xmin), Y(0)); ctxC.lineTo(X(xmax), Y(0)); ctxC.stroke();
    ctxC.beginPath(); ctxC.moveTo(X(0), Y(ymin)); ctxC.lineTo(X(0), Y(ymax)); ctxC.stroke();
    // labels
    ctxC.fillStyle='#cbd5e1'; ctxC.font='bold 24px system-ui';
    for(let gx=Math.ceil(xmin/10)*10; gx<=xmax; gx+=10){ const x=X(gx); ctxC.fillText(String(gx), x-14, h-20); }
    for(let gy=Math.ceil(ymin*2)/2; gy<=ymax; gy+=0.5){ const y=Y(gy); ctxC.fillText(String(gy.toFixed(1)), 18, y+8); }
    // points
    const styles=getComputedStyle(document.documentElement);
    const COL_G=styles.getPropertyValue('--g').trim();
    const COL_Y=styles.getPropertyValue('--y').trim();
    const COL_R=styles.getPropertyValue('--r').trim();
    pts.forEach(p=>{
      const color = p.r===1 ? COL_G : (p.r===2 ? COL_Y : COL_R);
      ctxC.fillStyle=color; ctxC.strokeStyle='rgba(255,255,255,.15)'; ctxC.lineWidth=3;
      ctxC.beginPath(); ctxC.arc(X(p.x), Y(p.y), 10, 0, Math.PI*2); ctxC.fill(); ctxC.stroke();
    });
  }

  // Print summary
  document.getElementById('btnPrint').onclick=()=>{
    if (!summary.classList.contains('show') && state.current){
      const s=computeSummary(state.current.shots);
      sumScore.textContent=`${s.score}/25`; sumFirst.textContent=String(s.first); sumSecond.textContent=String(s.second); sumMiss.textContent=String(s.missed);
      summary.classList.add('show'); drawHeat(state.current); drawChart(state.current);
    }
    setTimeout(()=>window.print(), 50);
  };

  // Events
  document.getElementById('btnNew').onclick=startRound;
  document.getElementById('btnEnd').onclick=()=>endRound(true);
  document.getElementById('btnUndo').onclick=undo;
  document.getElementById('dirIzq').onclick=()=>{ if(!dirBtn.Izq.disabled) selectDir('Izq'); };
  document.getElementById('dirCen').onclick=()=>{ if(!dirBtn.Cen.disabled) selectDir('Cen'); };
  document.getElementById('dirDer').onclick=()=>{ if(!dirBtn.Der.disabled) selectDir('Der'); };
  document.getElementById('r0').onclick=()=>addShot(0);
  document.getElementById('r1').onclick=()=>addShot(1);
  document.getElementById('r2').onclick=()=>addShot(2);
  document.getElementById('btnCsvSimple').onclick=()=>{
    const rows=[['Ronda','Esquema','No.Maquina','Resultado','Velocidad']]; const all=[...state.rounds]; if(state.current&&state.current.shots.length>0) all.push(state.current);
    all.forEach(R=>{ R.shots.forEach(s=> rows.push([R.number,R.esquema,s.machine,s.result,s.vel])); });
    const csv=rows.map(r=>r.join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='fo_simple_'+new Date().toISOString().slice(0,10)+'.csv'; a.click(); URL.revokeObjectURL(url);
  };
  document.getElementById('btnCsvDet').onclick=()=>{
    const rows=[['round_number','esquema','shot_index','pos','dir','vel','machine','result','ts']]; const all=[...state.rounds]; if(state.current&&state.current.shots.length>0) all.push(state.current);
    all.forEach(R=>{ R.shots.forEach((s,idx)=> rows.push([R.number,R.esquema,idx+1,s.pos,s.dir,s.vel,s.machine,s.result,s.ts])); });
    const csv=rows.map(r=>r.join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='fo_detallado_'+new Date().toISOString().slice(0,10)+'.csv'; a.click(); URL.revokeObjectURL(url);
  };
  document.getElementById('btnClearAll').onclick=()=>{ if(!confirm('Borrar rondas y contador?'))return; localStorage.removeItem(storageKey); localStorage.removeItem(roundsKey); location.reload(); };
  document.getElementById('btnHelp').onclick=()=>alert('Direcci√≥n ‚Üí Velocidad ‚Üí 0/1/2. Heatmap: fila 2 resultado (1 sin color, 2 amarillo, 0 rojo) y fila 3 velocidad (G:0.6‚Äì0.7, Y:0.5‚Äì0.8, R:0.4/0.9/1.0+). Exporta velocidad en CSV. Impresi√≥n con fondo blanco.');

  // Init
  (function init(){
    esquemaSel.value='1'; startPosSel.value='1';
    for(const k of Object.keys(dirBtn)){ dirBtn[k].disabled=true; }
    document.getElementById('shotTot').textContent='25';
  })();
  </script>

<script>
(function(){
  function fmtDate(d){
    try{ return new Date(d).toLocaleString(); }catch(e){ return new Date().toLocaleString(); }
  }
  function updatePrintHeader(round){
    try{
      var phR = document.getElementById('phRonda');
      var phE = document.getElementById('phEsquema');
      var phF = document.getElementById('phFecha');
      if(!phR || !phE || !phF) return;
      if (round && round.number) phR.textContent = String(round.number);
      if (round && round.esquema) phE.textContent = String(round.esquema);
      phF.textContent = new Date().toLocaleString();
    }catch(e){}
  }
  // Hook into existing print button if present
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('btnPrint');
    if (btn) {
      var hook = function(){
        try{
          // If state.current exists in page scope use it; otherwise try last stored round (best effort)
          var round = (window.state && window.state.current) ? window.state.current : null;
          updatePrintHeader(round);
        }catch(e){}
        setTimeout(function(){ window.print(); }, 50);
      };
      // Avoid double-binding if already has listener
      btn.addEventListener('click', function(ev){
        // Let existing code run (if any), but also set header right away
        try{
          var round = (window.state && window.state.current) ? window.state.current : null;
          updatePrintHeader(round);
        }catch(e){}
      }, false);
    }
    // Expose globally so other code can call when muestra resumen
    window.__updatePrintHeader = updatePrintHeader;
  });
})();
</script>


<script>
// Fix: ensure esquema dropdown is populated on iPhone/iPad after DOM is ready
document.addEventListener('DOMContentLoaded', function(){
  try {
    var sel = document.getElementById('esquemaSel');
    var startPosSel = document.getElementById('startPos');
    if (!sel) return;
    // clear and populate from parsed schemas (1..9)
    if (typeof schemas !== 'undefined' && schemas.esquemas && schemas.esquemas.length) {
      sel.innerHTML = '';
      schemas.esquemas.forEach(function(e){
        var o = document.createElement('option');
        o.value = e;
        o.textContent = 'Esquema ' + e;
        sel.appendChild(o);
      });
    } else {
      // Fallback: add 1..9 if schemas not visible
      sel.innerHTML = '';
      for (var i=1;i<=9;i++){ var o=document.createElement('option'); o.value=i; o.textContent='Esquema '+i; sel.appendChild(o); }
    }
    if (!sel.value) sel.value = '1';
    if (startPosSel && !startPosSel.value) startPosSel.value = '1';
  } catch(e) { /* no-op */ }
});
</script>


<script>
(function(){
  function updatePrintHeader(round){
    try{
      var phR = document.getElementById('phRonda');
      var phE = document.getElementById('phEsquema');
      var phF = document.getElementById('phFecha');
      if(!phR || !phE || !phF) return;
      // Try to read from 'state.current' if available, fallback to last stored round
      var r = round;
      if (!r && window.state && window.state.current) r = window.state.current;
      if (!r && window.localStorage) {
        try{
          var store = JSON.parse(localStorage.getItem('fo_ronda25_velocity_print_v1')||'{}');
          if (store.rounds && store.rounds.length) r = store.rounds[store.rounds.length-1];
        }catch(e){}
      }
      if (r && r.number) phR.textContent = String(r.number);
      if (r && typeof r.esquema !== 'undefined') phE.textContent = String(r.esquema);
      phF.textContent = new Date().toLocaleString();
    }catch(e){}
  }
  // Expose globally so app code can call it
  window.__updatePrintHeader = updatePrintHeader;

  // If there's a print button, hook it
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('btnPrint');
    if (btn) {
      btn.addEventListener('click', function(){
        try{ updatePrintHeader(window.state && window.state.current ? window.state.current : null); }catch(e){}
      }, false);
    }
    // Also observe when summary becomes visible to fill header
    var summary = document.getElementById('summary');
    if (summary && window.MutationObserver){
      var obs = new MutationObserver(function(muts){
        muts.forEach(function(m){
          if (m.attributeName === 'class' && summary.classList.contains('show')){
            updatePrintHeader(window.state && window.state.current ? window.state.current : null);
          }
        });
      });
      obs.observe(summary, { attributes:true });
    }
  });
})();
</script>


<script>
// Robust fix for iOS: always populate esquema 1..9 on load and before iniciar
(function(){
  function ensureEsquemas(){
    var sel = document.getElementById('esquemaSel');
    if (!sel) return;
    if (!sel.options || sel.options.length < 1){
      sel.innerHTML = '';
      for (var i=1;i<=9;i++){ var o=document.createElement('option'); o.value=i; o.textContent='Esquema '+i; sel.appendChild(o); }
    }
  }
  document.addEventListener('DOMContentLoaded', function(){
    // First, try to use parsed schemas; if not available, fallback to 1..9
    try{
      var sel = document.getElementById('esquemaSel');
      if (sel){
        sel.innerHTML='';
        if (window.schemas && schemas.esquemas && schemas.esquemas.length){
          schemas.esquemas.forEach(function(e){ var o=document.createElement('option'); o.value=e; o.textContent='Esquema '+e; sel.appendChild(o); });
        } else {
          for (var i=1;i<=9;i++){ var o=document.createElement('option'); o.value=i; o.textContent='Esquema '+i; sel.appendChild(o); }
        }
        if (!sel.value) sel.value = '1';
      }
    }catch(e){ ensureEsquemas(); }
    // Guardar tambi√©n al tocar "Nueva ronda"
    var btnNew = document.getElementById('btnNew');
    if (btnNew){
      btnNew.addEventListener('click', function(){
        ensureEsquemas();
      }, true);
    }
  });
})();
</script>

</body>
</html>