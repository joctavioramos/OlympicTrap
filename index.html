<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>Olympic Trap Training - Octavio Ramos</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#111111; --muted:#475569; --line:#e2e8f0;
      --g:#22c55e; --y:#facc15; --r:#ef4444; --primary:#0ea5e9;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; background:var(--bg); color:var(--fg);}
    .container{max-width:1200px;margin:0 auto;padding:16px;}
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.05);padding:16px;}
    h1{margin:.2rem 0 .4rem;font-size:24px} h2{margin:.4rem 0 10px;font-size:16px;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{background:#f8fafc;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:12px}
    button,select{background:#fff;color:var(--fg);border:1px solid var(--line);border-radius:12px;padding:12px 14px;font-size:18px;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#38bdf8,#0ea5e9);border:0;color:#04243c;font-weight:800}
    button:disabled{opacity:.55;cursor:not-allowed}
    .grid{display:grid;gap:10px}
    .dirGrid{grid-template-columns:repeat(3,1fr)}
    .velGrid{grid-template-columns:repeat(7,1fr)}
    .pill{padding:12px 10px;border-radius:12px;border:1px solid var(--line);text-align:center;font-weight:800;background:#fff}
    .pill.active{outline:2px solid var(--primary)}
    table{width:100%;border-collapse:collapse;font-size:14px;border:1px solid var(--line)}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;background:#fff}
    thead th{position:sticky;top:0;background:#f8fafc;z-index:1}
    /* Resumen claro */
    #summary{background:#fff;color:#111;border:1px solid var(--line);border-radius:14px;padding:14px;display:none}
    #summary.show{display:block}
    .sum-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:4px}
    .sum-card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;text-align:center}
    .sum-label{font-size:13px;color:#334155}
    .sum-value{font-size:24px;font-weight:900}
    .sum-score{color:#0ea5e9} .sum-first{color:#16a34a} .sum-second{color:#a855f7} .sum-missed{color:#ef4444}
    .heat-wrap,.heat2-wrap,.chart-wrap{margin-top:12px;background:#fff;border:1px solid var(--line);border-radius:10px;padding:12px}
    #heat,#heatVR,#chart{width:100%;background:#fff;border-radius:8px}
    /* 0/1/2 primero */
    .resBtns{display:flex;gap:12px;flex-wrap:wrap}
    .btn-res{padding:18px 22px;font-size:22px;font-weight:900;border-radius:16px;border:0;cursor:pointer}
    .btn-res.res0{background:var(--r);color:#fff}
    .btn-res.res1{background:var(--g);color:#0b0b0b}
    .btn-res.res2{background:var(--y);color:#0b0b0b}
    /* Tablet */
    @media (min-width:900px){
      .btn-res{padding:24px 28px;font-size:26px}
      .dirGrid .pill,.velGrid .pill{padding:16px 12px;font-size:18px}
      table{font-size:16px}
      h1{font-size:26px}
      .container{max-width:1280px}
    }
    /* Print: Carta landscape, 1 p√°gina */
    @media print{
      @page{size:Letter landscape;margin:8mm}
      html,body{background:#fff;color:#111}
      .no-print{display:none!important}
      #summary{display:block!important;border:0;padding:0}
      .heat-wrap,.heat2-wrap,.chart-wrap{border:0;padding:0}
      .sum-grid{gap:8px}
      .sum-value{font-size:20px}
      #heat{height:110px!important}
      #heatVR{height:160px!important}
      #chart{height:200px!important}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row no-print" style="justify-content:space-between;align-items:center">
      <h1>Olympic Trap Training - Octavio Ramos</h1>
      <div class="row">
        <span class="chip" id="roundInfo">Sin ronda</span>
        <button id="btnPrint" class="primary">Imprimir resumen (PDF)</button>
      </div>
    </div>

    <div class="card no-print">
      <h2>1) Esquema y Posici√≥n de inicio</h2>
      <div class="row">
        <label>Esquema</label>
        <select id="esquemaSel">
          <option value="1">Esquema 1</option><option value="2">Esquema 2</option><option value="3">Esquema 3</option>
          <option value="4">Esquema 4</option><option value="5">Esquema 5</option><option value="6">Esquema 6</option>
          <option value="7">Esquema 7</option><option value="8">Esquema 8</option><option value="9">Esquema 9</option>
        </select>
        <label>Posici√≥n inicial</label>
        <select id="startPos"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>
        <button id="btnNew" class="primary">Nueva ronda (25)</button>
        <button id="btnEnd">Terminar</button>
        <button id="btnUndo">Deshacer</button>
      </div>
      <p class="small">Flujo: <b>0/1/2</b> ‚Üí <b>Izq/Cen/Der</b> ‚Üí <b>Velocidad</b> (default 0.6). L√≠mites: Izq=2, Cen=1, Der=2.</p>
    </div>

    <div class="card no-print">
      <h2>2) Captura r√°pida</h2>
      <!-- ORDEN NUEVO: 0/1/2 ‚Üí Direcci√≥n ‚Üí Velocidad -->
      <div class="row resBtns" style="margin-top:4px">
        <button id="r0" class="btn-res res0">0 ‚Äî Fallo</button>
        <button id="r1" class="btn-res res1">1 ‚Äî 1er disparo</button>
        <button id="r2" class="btn-res res2">2 ‚Äî 2¬∫ disparo</button>
      </div>
      <div class="grid dirGrid" style="margin-top:10px">
        <button class="pill" id="dirIzq">Izq</button>
        <button class="pill" id="dirCen">Cen</button>
        <button class="pill" id="dirDer">Der</button>
      </div>
      <div class="grid velGrid" style="margin-top:10px">
        <button class="pill" data-vel="0.4">0.4</button><button class="pill" data-vel="0.5">0.5</button>
        <button class="pill active" data-vel="0.6">0.6</button><button class="pill" data-vel="0.7">0.7</button>
        <button class="pill" data-vel="0.8">0.8</button><button class="pill" data-vel="0.9">0.9</button>
        <button class="pill" data-vel="1.0">1.0</button>
      </div>
    </div>

    <div class="card no-print" style="margin-top:12px">
      <h2>3) Progreso</h2>
      <div class="small">Esquema: <span id="esquemaActivo">‚Äî</span> ‚Ä¢ Pos: <span id="posActivo">‚Äî</span> ‚Ä¢ Dir: <span id="dirActivo">‚Äî</span> ‚Ä¢ Vel: <span id="velActivo">‚Äî</span> ‚Ä¢ Disparo: <span id="shotNo">0</span> / <span id="shotTot">25</span></div>
      <div style="max-height:340px;overflow:auto;margin-top:6px">
        <table>
          <thead><tr><th>#</th><th>Pos</th><th>Dir</th><th>Vel</th><th>M√°q</th><th>Res</th><th>√Ångulo1</th><th>Altura</th><th>√Ångulo</th><th>Direcci√≥n</th></tr></thead>
          <tbody id="shotsBody"></tbody>
        </table>
      </div>
    </div>

    <div id="summary" class="summary">
      <div id="printHeader" style="text-align:center;margin-bottom:6px;color:#111">
        <div style="font-weight:800;font-size:18px">Resumen ‚Äî Ronda <span id="phRonda">#</span> ‚Äî Esquema <span id="phEsquema">?</span></div>
        <div style="font-size:12px;color:#444">Generado: <span id="phFecha">‚Äî</span></div>
      </div>
      <div class="sum-grid">
        <div class="sum-card"><div class="sum-label">Marcador</div><div id="sumScore" class="sum-value sum-score">0/25</div></div>
        <div class="sum-card"><div class="sum-label">1er disparo</div><div id="sumFirst" class="sum-value sum-first">0</div></div>
        <div class="sum-card"><div class="sum-label">2¬∫ disparo</div><div id="sumSecond" class="sum-value sum-second">0</div></div>
        <div class="sum-card"><div class="sum-label">Fallados</div><div id="sumMiss" class="sum-value sum-missed">0</div></div>
      </div>
      <div class="heat-wrap">
        <div class="row" style="justify-content:space-between">
          <div class="small">Heatmap de la ronda (1..25)</div>
          <div class="legend small"><span style="width:12px;height:12px;border-radius:50%;display:inline-block;border:1px solid #94a3b8;background:transparent"></span> 1er ‚Ä¢ <span style="width:12px;height:12px;border-radius:50%;background:var(--y);display:inline-block"></span> 2¬∫ ‚Ä¢ <span style="width:12px;height:12px;border-radius:50%;background:var(--r);display:inline-block"></span> Fallo</div>
        </div>
        <canvas id="heat" height="320"></canvas>
      </div>
      <div class="heat2-wrap">
        <div class="row" style="justify-content:space-between">
          <div class="small">Heatmap Tiempo (s) √ó Resultado (0/1/2)</div>
          <div class="legend small"><span style="width:12px;height:12px;border-radius:50%;background:var(--y);display:inline-block"></span> 2¬∫ ‚Ä¢ <span style="width:12px;height:12px;border-radius:50%;background:var(--r);display:inline-block"></span> Fallo ‚Ä¢ <span style="width:12px;height:12px;border-radius:50%;display:inline-block;border:1px solid #94a3b8;background:transparent"></span> 1er</div>
        </div>
        <canvas id="heatVR" height="360"></canvas>
        <div class="small" style="margin-top:6px">Filas: 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0 ‚Ä¢ Columnas: 1..25</div>
      </div>
      <div class="chart-wrap">
        <div class="row" style="justify-content:space-between">
          <div class="small">Gr√°fica ‚Äî ùë• = √Ångulo (¬∞) / ùë¶ = Altura (jitter ¬±0.2¬∞ / ¬±0.03)</div>
          <div class="legend small"><span style="width:12px;height:12px;border-radius:50%;display:inline-block;border:1px solid #94a3b8;background:transparent"></span> 1er ‚Ä¢ <span style="width:12px;height:12px;border-radius:50%;background:var(--y);display:inline-block"></span> 2¬∫ ‚Ä¢ <span style="width:12px;height:12px;border-radius:50%;background:var(--r);display:inline-block"></span> Fallo</div>
        </div>
        <canvas id="chart" height="380"></canvas>
      </div>

      <div class="row no-print" style="margin-top:10px; justify-content:flex-end">
        <button id="btnSaveDB" class="pill">Guardar ronda en BD</button>
        <button id="btnExportDB" class="pill">Exportar BD (JSON)</button>
        <button id="btnClearDB" class="pill">Vaciar BD</button>
        <span id="dbInfo" class="chip">BD: 0 rondas</span>
      </div>
    </div>
  </div>

  <script>
  /* === ESQUEMAS CSV (9) === */
  const SCHEMAS_CSV = `Codigo,Esquema,Posicion,Maquina,Angulo1,Altura,Angulo,Direccion
1.01,1,1,1,25,2.00,25,R
1.02,1,1,2,-5,3.00,5,L
1.03,1,1,3,-35,1.50,35,L
1.04,1,2,4,45,2.50,45,R
1.05,1,2,5,10,1.80,10,R
1.06,1,2,6,-35,3.00,35,L
1.07,1,3,7,35,3.00,35,R
1.08,1,3,8,-5,1.50,5,L
1.09,1,3,9,-45,1.60,45,L
1.1,1,4,10,40,1.50,40,R
1.11,1,4,11,0,3.00,0,C
1.12,1,4,12,-25,2.60,25,L
1.13,1,5,13,20,2.40,20,R
1.14,1,5,14,5,1.90,5,R
1.15,1,5,15,-35,3.00,35,L
2.01,2,1,1,25,3.00,25,R
2.02,2,1,2,-5,1.80,5,L
2.03,2,1,3,-35,2.00,35,L
2.04,2,2,4,40,2.00,40,R
2.05,2,2,5,0,3.00,0,C
2.06,2,2,6,-45,1.60,45,L
2.07,2,3,7,45,1.50,45,R
2.08,2,3,8,0,2.80,0,C
2.09,2,3,9,-40,2.00,40,L
2.1,2,4,10,15,1.50,15,R
2.11,2,4,11,5,2.00,5,R
2.12,2,4,12,-35,1.80,35,L
2.13,2,5,13,35,1.80,35,R
2.14,2,5,14,-5,1.50,5,L
2.15,2,5,15,-40,3.00,40,L
3.01,3,1,1,30,2.50,30,R
3.02,3,1,2,0,2.80,0,C
3.03,3,1,3,-35,3.00,35,L
3.04,3,2,4,45,1.50,45,R
3.05,3,2,5,-5,2.50,5,L
3.06,3,2,6,-40,1.70,40,L
3.07,3,3,7,30,2.80,30,R
3.08,3,3,8,5,3.00,5,R
3.09,3,3,9,-45,1.50,45,L
3.1,3,4,10,45,2.30,45,R
3.11,3,4,11,0,3.00,0,C
3.12,3,4,12,-40,1.60,40,L
3.13,3,5,13,30,2.00,30,R
3.14,3,5,14,0,1.50,0,C
3.15,3,5,15,-35,2.20,35,L
4.01,4,1,1,40,3.00,40,R
4.02,4,1,2,10,1.50,10,R
4.03,4,1,3,-30,2.20,30,L
4.04,4,2,4,30,1.60,30,R
4.05,4,2,5,-10,3.00,10,L
4.06,4,2,6,-35,2.00,35,L
4.07,4,3,7,45,2.00,45,R
4.08,4,3,8,0,3.00,0,C
4.09,4,3,9,-20,1.50,20,L
4.1,4,4,10,30,1.50,30,R
4.11,4,4,11,-5,2.00,5,L
4.12,4,4,12,-45,2.80,45,L
4.13,4,5,13,35,2.50,35,R
4.14,4,5,14,0,1.60,0,C
4.15,4,5,15,-30,3.00,30,L
5.01,5,1,1,45,1.60,45,R
5.02,5,1,2,0,3.00,0,C
5.03,5,1,3,-15,2.00,15,L
5.04,5,2,4,40,2.80,40,R
5.05,5,2,5,-10,1.50,10,L
5.06,5,2,6,-45,2.00,45,L
5.07,5,3,7,35,3.00,35,R
5.08,5,3,8,-5,1.80,5,L
5.09,5,3,9,-40,1.50,40,L
5.1,5,4,10,25,1.80,25,R
5.11,5,4,11,0,1.60,0,C
5.12,5,4,12,-30,3.00,30,L
5.13,5,5,13,30,2.00,30,R
5.14,5,5,14,10,2.40,10,R
5.15,5,5,15,-15,1.80,15,L
6.01,6,1,1,40,2.00,40,R
6.02,6,1,2,0,3.00,0,C
6.03,6,1,3,-35,1.50,35,L
6.04,6,2,4,35,2.50,35,R
6.05,6,2,5,10,1.50,10,R
6.06,6,2,6,-35,2.00,35,L
6.07,6,3,7,35,2.00,35,R
6.08,6,3,8,-5,1.50,5,L
6.09,6,3,9,-40,3.00,40,L
6.1,6,4,10,45,1.50,45,R
6.11,6,4,11,-10,3.00,10,L
6.12,6,4,12,-25,2.60,25,L
6.13,6,5,13,25,2.40,25,R
6.14,6,5,14,5,1.50,5,R
6.15,6,5,15,-45,2.00,45,L
7.01,7,1,1,35,2.20,35,R
7.02,7,1,2,-5,3.00,5,L
7.03,7,1,3,-20,3.00,20,L
7.04,7,2,4,40,2.00,40,R
7.05,7,2,5,0,3.00,0,C
7.06,7,2,6,-45,2.80,45,L
7.07,7,3,7,40,3.00,40,R
7.08,7,3,8,0,2.00,0,C
7.09,7,3,9,-40,2.20,40,L
7.1,7,4,10,45,1.50,45,R
7.11,7,4,11,5,2.00,5,R
7.12,7,4,12,-35,1.80,35,L
7.13,7,5,13,20,1.80,20,R
7.14,7,5,14,-5,1.50,5,L
7.15,7,5,15,-45,2.00,45,L
8.01,8,1,1,25,3.00,25,R
8.02,8,1,2,5,1.50,5,R
8.03,8,1,3,-20,2.00,20,L
8.04,8,2,4,40,1.50,40,R
8.05,8,2,5,0,3.00,0,C
8.06,8,2,6,-45,2.80,45,L
8.07,8,3,7,35,3.00,35,R
8.08,8,3,8,-5,2.50,5,L
8.09,8,3,9,-45,2.00,45,L
8.1,8,4,10,45,1.80,45,R
8.11,8,4,11,0,1.50,0,C
8.12,8,4,12,-30,3.00,30,L
8.13,8,5,13,30,2.00,30,R
8.14,8,5,14,10,3.00,10,R
8.15,8,5,15,-15,2.20,15,L
9.01,9,1,1,40,3.00,40,R
9.02,9,1,2,0,1.80,0,C
9.03,9,1,3,-20,3.00,20,L
9.04,9,2,4,15,3.00,15,R
9.05,9,2,5,-10,1.50,10,L
9.06,9,2,6,-35,2.00,35,L
9.07,9,3,7,45,1.60,45,R
9.08,9,3,8,0,2.80,0,C
9.09,9,3,9,-30,3.00,30,L
9.1,9,4,10,30,2.00,30,R
9.11,9,4,11,-5,2.00,5,L
9.12,9,4,12,-15,3.00,15,L
9.13,9,5,13,35,2.90,35,R
9.14,9,5,14,0,1.60,0,C
9.15,9,5,15,-45,2.20,45,L`;

  function parseSchemas(csv){
    const lines = csv.trim().split(/\r?\n/); const header = lines.shift().split(',').map(s=>s.trim()); const idx=n=>header.indexOf(n);
    const bySchema=new Map(), esquemas=new Set();
    for(const line of lines){
      const c=line.split(',').map(s=>s.trim());
      const esquema=Number(c[idx('Esquema')]); const pos=Number(c[idx('Posicion')]); const machine=Number(c[idx('Maquina')]);
      const meta={ pos, machine, ang1:Number(c[idx('Angulo1')]), alt:Number(c[idx('Altura')]), ang:Number(c[idx('Angulo')]), dir:c[idx('Direccion')] };
      if(!bySchema.has(esquema)) bySchema.set(esquema,{machines:{},posMap:new Map()});
      const e=bySchema.get(esquema); e.machines[machine]=meta; if(!e.posMap.has(pos)) e.posMap.set(pos,[]); e.posMap.get(pos).push(machine); esquemas.add(esquema);
    }
    for(const e of bySchema.values()){ for(const [p,arr] of e.posMap.entries()) arr.sort((a,b)=>a-b); }
    return { bySchema, esquemas:[...esquemas].sort((a,b)=>a-b) };
  }
  const schemas=parseSchemas(SCHEMAS_CSV);

  /* === Estado y helpers === */
  const LIMITS={Izq:2,Cen:1,Der:2};
  const roundsKey='fo_round_counter';
  const storageKey='fo_tablet_db_v1';
  const state={ current:null };

  const esquemaSel=document.getElementById('esquemaSel');
  const startPosSel=document.getElementById('startPos');
  const shotsBody=document.getElementById('shotsBody');
  const esquemaActivo=document.getElementById('esquemaActivo');
  const posActivo=document.getElementById('posActivo');
  const dirActivo=document.getElementById('dirActivo');
  const velActivo=document.getElementById('velActivo');
  const shotNoSpan=document.getElementById('shotNo');
  const roundInfo=document.getElementById('roundInfo');
  const summary=document.getElementById('summary');
  const sumScore=document.getElementById('sumScore');
  const sumFirst=document.getElementById('sumFirst');
  const sumSecond=document.getElementById('sumSecond');
  const sumMiss=document.getElementById('sumMiss');
  const heat=document.getElementById('heat');
  const heatVR=document.getElementById('heatVR');
  const chart=document.getElementById('chart');
  let ctxH=null, ctxVR=null, ctxC=null;

  const dirBtn={ Izq:document.getElementById('dirIzq'), Cen:document.getElementById('dirCen'), Der:document.getElementById('dirDer') };
  const velBtns=[...document.querySelectorAll('.velGrid [data-vel]')];

  let selectedDir='Izq', selectedVel='0.6';
  function selectDir(d){ selectedDir=d; dirActivo&&(dirActivo.textContent=d); Object.keys(dirBtn).forEach(k=> dirBtn[k].classList.toggle('active',k===d)); }
  function selectVel(v){ selectedVel=v; velActivo&&(velActivo.textContent=v); velBtns.forEach(b=> b.classList.toggle('active', b.dataset.vel===v)); }
  velBtns.forEach(b=> b.onclick=()=>selectVel(b.dataset.vel));

  function nextRoundNumber(){ const n=Number(localStorage.getItem(roundsKey)||'0')+1; localStorage.setItem(roundsKey,String(n)); return n; }
  function newCounts(){ return {1:{Izq:0,Cen:0,Der:0},2:{Izq:0,Cen:0,Der:0},3:{Izq:0,Cen:0,Der:0},4:{Izq:0,Cen:0,Der:0},5:{Izq:0,Cen:0,Der:0}}; }
  function inferMachine(esq,pos,dir){ const e=schemas.bySchema.get(esq); if(!e) return null; const trio=e.posMap.get(pos)||[]; const idx=dir==='Izq'?0:(dir==='Cen'?1:2); return trio[idx]??null; }

  function renderShots(){
    shotsBody.innerHTML='';
    if(!state.current) return;
    const e=schemas.bySchema.get(state.current.esquema);
    state.current.shots.forEach((s,i)=>{
      const m=e.machines[s.machine]||{};
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i+1}</td><td>${s.pos}</td><td>${s.dir}</td><td>${s.vel}</td><td>${s.machine}</td><td>${s.result}</td>
                    <td>${m.ang1??''}</td><td>${m.alt??''}</td><td>${m.ang??''}</td><td>${m.dir??''}</td>`;
      shotsBody.appendChild(tr);
    });
    posActivo&&(posActivo.textContent=state.current.pos);
    dirActivo&&(dirActivo.textContent=selectedDir);
    velActivo&&(velActivo.textContent=selectedVel);
    shotNoSpan&&(shotNoSpan.textContent=String(state.current.shots.length+1));
  }

  function updateDirButtons(){
    const cur=state.current;
    Object.keys(dirBtn).forEach(k=>{ dirBtn[k].disabled=!cur; if(!cur) dirBtn[k].classList.remove('active'); });
    if(!cur) return;
    const pos=cur.pos;
    dirBtn.Izq.disabled = cur.counts[pos].Izq >= LIMITS.Izq;
    dirBtn.Cen.disabled = cur.counts[pos].Cen >= LIMITS.Cen;
    dirBtn.Der.disabled = cur.counts[pos].Der >= LIMITS.Der;
    if (dirBtn[selectedDir].disabled){
      const next = !dirBtn.Izq.disabled ? 'Izq' : (!dirBtn.Cen.disabled ? 'Cen' : (!dirBtn.Der.disabled ? 'Der' : null));
      if (next) selectDir(next);
    }
  }

  function computeSummary(shots){ let first=0,second=0,missed=0; shots.forEach(s=>{ if(s.result===1) first++; else if(s.result===2) second++; else missed++; }); return {first,second,missed,score:first+second}; }

  function startRound(){
    const esquema=Number(esquemaSel && esquemaSel.value ? esquemaSel.value : 1);
    const startPos=Number(startPosSel.value||1);
    const number=nextRoundNumber();
    state.current={ id:'RND-'+Date.now(), number, esquema, date:new Date().toISOString(), size:25, pos:startPos, shots:[], counts:newCounts() };
    esquemaActivo&&(esquemaActivo.textContent=String(esquema));
    posActivo&&(posActivo.textContent=String(startPos));
    shotNoSpan&&(shotNoSpan.textContent='1'); roundInfo&&(roundInfo.textContent='Ronda #'+number);
    selectDir('Izq'); selectVel('0.6'); summary&&summary.classList.remove('show');
    renderShots(); updateDirButtons();
  }

  function endRound(show){
    if(!state.current) return;
    const s=computeSummary(state.current.shots);
    sumScore.textContent=`${s.score}/25`; sumFirst.textContent=String(s.first); sumSecond.textContent=String(s.second); sumMiss.textContent=String(s.missed);
    document.getElementById('phRonda').textContent=String(state.current.number);
    document.getElementById('phEsquema').textContent=String(state.current.esquema);
    document.getElementById('phFecha').textContent=new Date().toLocaleString();
    summary.classList.add('show');
    drawHeat(state.current); drawHeatVR(state.current); drawChart(state.current);
    try{ const store=JSON.parse(localStorage.getItem(storageKey)||'{}'); if(!store.rounds) store.rounds=[]; store.rounds.push(JSON.parse(JSON.stringify(state.current))); localStorage.setItem(storageKey, JSON.stringify(store)); }catch(e){}
  }

  function undo(){
    if(!state.current || state.current.shots.length===0) return;
    const last=state.current.shots.pop(); state.current.pos=last.pos; state.current.counts[last.pos][last.dir]-=1;
    selectVel('0.6'); renderShots(); updateDirButtons();
  }

  function addShot(result){
    if(!state.current){ alert('Inicia una ronda.'); return; }
    if(state.current.shots.length>=25){ alert('Ronda completa.'); return; }
    const pos=state.current.pos; const dir=selectedDir;
    const used=state.current.counts[pos][dir]; if(used>=LIMITS[dir]){ alert('Cupo lleno en '+dir+' para pos '+pos); return; }
    const m=inferMachine(state.current.esquema,pos,dir) ?? ((pos-1)*3 + (dir==='Izq'?1:dir==='Cen'?2:3));
    state.current.shots.push({ pos, dir, vel:selectedVel, machine:m, result, ts:Date.now() });
    state.current.counts[pos][dir]+=1;
    state.current.pos=(pos%5)+1;
    selectVel('0.6'); renderShots(); updateDirButtons();
    if(state.current.shots.length===25) endRound(true);
  }

  document.getElementById('btnNew').onclick=startRound;
  document.getElementById('btnEnd').onclick=()=>endRound(true);
  document.getElementById('btnUndo').onclick=undo;
  document.getElementById('dirIzq').onclick=()=>selectDir('Izq');
  document.getElementById('dirCen').onclick=()=>selectDir('Cen');
  document.getElementById('dirDer').onclick=()=>selectDir('Der');
  document.getElementById('r0').onclick=()=>addShot(0);
  document.getElementById('r1').onclick=()=>addShot(1);
  document.getElementById('r2').onclick=()=>addShot(2);

  /* === Heatmap ronda === */
  function drawHeat(round){
    if(!ctxH) ctxH=heat.getContext('2d');
    const w=heat.width=heat.clientWidth*2, h=heat.height=heat.clientHeight*2; ctxH.setTransform(1,0,0,1,0,0); ctxH.clearRect(0,0,w,h);
    const cols=25; const cellW=(w-180)/cols; const cellH=36; const x0=10, yH=10, yR=yH+cellH+10, yV=yR+cellH+8;
    const COL_Y=getComputedStyle(document.documentElement).getPropertyValue('--y').trim();
    const COL_R=getComputedStyle(document.documentElement).getPropertyValue('--r').trim();
    const COL_G=getComputedStyle(document.documentElement).getPropertyValue('--g').trim();
    ctxH.lineWidth=2; ctxH.strokeStyle='#cbd5e1'; ctxH.fillStyle='#111'; ctxH.font='bold 22px system-ui';
    for(let i=0;i<cols;i++){ const x=x0+i*cellW; ctxH.strokeRect(x,yH,cellW,cellH); const lab=String(i+1); const tw=ctxH.measureText(lab).width; ctxH.fillText(lab, x+cellW/2-tw/2, yH+cellH/2+8); }
    const totX=x0+cols*cellW+10, totW=150; ctxH.strokeRect(totX,yH,totW,cellH); const twt=ctxH.measureText('TOTAL').width; ctxH.fillText('TOTAL', totX+totW/2-twt/2, yH+cellH/2+8);
    for(let i=0;i<cols;i++){ const x=x0+i*cellW; ctxH.strokeRect(x,yR,cellW,cellH); const s=round.shots[i]; if(!s) continue;
      if(s.result===2){ ctxH.fillStyle=COL_Y; ctxH.fillRect(x+2,yR+2,cellW-4,cellH-4); }
      else if(s.result===0){ ctxH.fillStyle=COL_R; ctxH.fillRect(x+2,yR+2,cellW-4,cellH-4); }
      ctxH.fillStyle='#111'; ctxH.font='bold 24px system-ui'; const tx=s.result===0?'0':String(s.result); const tw=ctxH.measureText(tx).width; ctxH.fillText(tx, x+cellW/2-tw/2, yR+cellH/2+9); }
    for(let i=0;i<cols;i++){ const x=x0+i*cellW; ctxH.strokeRect(x,yV,cellW,cellH); const s=round.shots[i]; if(!s) continue; const v=s.vel; let col=null;
      if(v==='0.6'||v==='0.7') col=COL_G; else if(v==='0.5'||v==='0.8') col=COL_Y; else if(v==='0.4'||v==='0.9'||v==='1.0') col=COL_R;
      if(col){ ctxH.fillStyle=col; ctxH.fillRect(x+2,yV+2,cellW-4,cellH-4); }
      ctxH.fillStyle='#111'; ctxH.font='bold 20px system-ui'; const tw=ctxH.measureText(v).width; ctxH.fillText(v, x+cellW/2-tw/2, yV+cellH/2+7); }
    const score=round.shots.reduce((s,a)=>s+(a.result>0?1:0),0); ctxH.fillStyle='#111'; ctxH.font='bold 26px system-ui'; const tscore=String(score); const tw2=ctxH.measureText(tscore).width; ctxH.fillText(tscore, totX+totW/2-tw2/2, yR+cellH/2+10); ctxH.strokeRect(totX,yR,totW,cellH);
  }

  /* === Heatmap Tiempo x Resultado === */
  function drawHeatVR(round){
    if(!ctxVR) ctxVR=heatVR.getContext('2d');
    const w=heatVR.width=heatVR.clientWidth*2, h=heatVR.height=heatVR.clientHeight*2; ctxVR.setTransform(1,0,0,1,0,0); ctxVR.clearRect(0,0,w,h);
    const velocities=['0.4','0.5','0.6','0.7','0.8','0.9','1.0']; const cols=25; const rows=velocities.length;
    const leftPad=70, topPad=20, cellW=(w-leftPad-10)/cols, cellH=(h-topPad-20)/rows;
    const COL_Y=getComputedStyle(document.documentElement).getPropertyValue('--y').trim();
    const COL_R=getComputedStyle(document.documentElement).getPropertyValue('--r').trim();
    ctxVR.lineWidth=1.8; ctxVR.strokeStyle='#cbd5e1'; ctxVR.fillStyle='#111'; ctxVR.font='bold 20px system-ui';
    velocities.forEach((v,ri)=>{ const y=topPad+ri*cellH; ctxVR.fillText(v, 14, y+cellH*0.65); });
    for(let c=0;c<cols;c++){
      const s=round.shots[c];
      for(let r=0;r<rows;r++){
        const x=leftPad+c*cellW, y=topPad+r*cellH; ctxVR.strokeRect(x,y,cellW,cellH);
        if(!s) continue;
        if(s.vel===velocities[r]){
          if(s.result===2){ ctxVR.fillStyle=COL_Y; ctxVR.fillRect(x+2,y+2,cellW-4,cellH-4); }
          else if(s.result===0){ ctxVR.fillStyle=COL_R; ctxVR.fillRect(x+2,y+2,cellW-4,cellH-4); }
          ctxVR.fillStyle='#111'; const tx=String(s.result); const tw=ctxVR.measureText(tx).width; ctxVR.fillText(tx, x+cellW/2 - tw/2, y + cellH*0.65);
        }
      }
    }
    ctxVR.fillStyle='#111'; for(let c=0;c<cols;c++){ const x=leftPad+c*cellW; const label=String(c+1); const tw=ctxVR.measureText(label).width; ctxVR.fillText(label, x+cellW/2 - tw/2, h-8); }
  }

  /* === Gr√°fica === */
  function drawChart(round){
    if(!ctxC) ctxC=chart.getContext('2d');
    const e=schemas.bySchema.get(round.esquema); const metas=e.machines;
    const pts=round.shots.map((s,i)=>{ const m=metas[s.machine]||{}; const k=i%2; let dx=0,dy=0; if(s.dir==='Cen'){dx=0;dy=0;} else {dx=k===0?-0.2:+0.2; dy=k===0?-0.03:+0.03;} return {x:(m.ang1??0)+dx, y:(m.alt??0)+dy, r:s.result}; });
    const w=chart.width=chart.clientWidth*2, h=chart.height=chart.clientHeight*2; ctxC.setTransform(1,0,0,1,0,0); ctxC.clearRect(0,0,w,h);
    const xs=pts.map(p=>p.x), ys=pts.map(p=>p.y);
    const xmin=Math.min(-50,(xs.length?Math.min(...xs):-50))-2, xmax=Math.max(50,(xs.length?Math.max(...xs):50))+2;
    const ymin=Math.min(1.0,(ys.length?Math.min(...ys):1.0))-0.1, ymax=Math.max(3.5,(ys.length?Math.max(...ys):3.5))+0.1;
    const pl=70,pr=25,pt=20,pb=60; const X=v=>pl+(v-xmin)*(w-pl-pr)/(xmax-xmin); const Y=v=>h-pb-(v-ymin)*(h-pt-pb)/(ymax-ymin);
    ctxC.strokeStyle='#cbd5e1'; ctxC.lineWidth=1.8;
    for(let gx=Math.ceil(xmin/10)*10;gx<=xmax;gx+=10){ const x=X(gx); ctxC.beginPath(); ctxC.moveTo(x,Y(ymin)); ctxC.lineTo(x,Y(ymax)); ctxC.stroke(); }
    for(let gy=Math.ceil(ymin*2)/2;gy<=ymax;gy+=0.5){ const y=Y(gy); ctxC.beginPath(); ctxC.moveTo(X(xmin),y); ctxC.lineTo(X(xmax),y); ctxC.stroke(); }
    ctxC.strokeStyle='#64748b'; ctxC.lineWidth=3; ctxC.beginPath(); ctxC.moveTo(X(xmin),Y(0)); ctxC.lineTo(X(xmax),Y(0)); ctxC.stroke();
    ctxC.beginPath(); ctxC.moveTo(X(0),Y(ymin)); ctxC.lineTo(X(0),Y(ymax)); ctxC.stroke();
    ctxC.fillStyle='#111'; ctxC.font='bold 20px system-ui';
    for(let gx=Math.ceil(xmin/10)*10;gx<=xmax;gx+=10){ const x=X(gx); ctxC.fillText(String(gx), x-12, h-18); }
    for(let gy=Math.ceil(ymin*2)/2;gy<=ymax;gy+=0.5){ const y=Y(gy); ctxC.fillText(String(gy.toFixed(1)), 16, y+8); }
    pts.forEach(p=>{ const color=p.r===1?getComputedStyle(document.documentElement).getPropertyValue('--g').trim():p.r===2?getComputedStyle(document.documentElement).getPropertyValue('--y').trim():getComputedStyle(document.documentElement).getPropertyValue('--r').trim();
      ctxC.fillStyle=color; ctxC.strokeStyle='rgba(0,0,0,.12)'; ctxC.lineWidth=3; ctxC.beginPath(); ctxC.arc(X(p.x),Y(p.y),10,0,Math.PI*2); ctxC.fill(); ctxC.stroke(); });
  }

  /* === IndexedDB (guardar/exportar/vaciar) === */
  (function(){
    const DB_NAME='fo_trap_db'; const DB_VER=1; const STORE='rounds'; let _db=null;
    function openDB(){ return new Promise((res,rej)=>{ if(_db) return res(_db); const req=indexedDB.open(DB_NAME,DB_VER);
      req.onupgradeneeded=(ev)=>{const db=ev.target.result; if(!db.objectStoreNames.contains(STORE)){const os=db.createObjectStore(STORE,{keyPath:'id'}); os.createIndex('date','date',{unique:false});}};
      req.onsuccess=()=>{_db=req.result;res(_db)}; req.onerror=()=>rej(req.error); });}
    async function countRounds(){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readonly'); const rq=tx.objectStore(STORE).count(); rq.onsuccess=()=>res(rq.result||0); rq.onerror=()=>rej(rq.error); });}
    async function putRound(R){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); tx.objectStore(STORE).put(R); });}
    async function getAllRounds(){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readonly'); const rq=tx.objectStore(STORE).getAll(); rq.onsuccess=()=>res(rq.result||[]); rq.onerror=()=>rej(rq.error); });}
    async function clearDB(){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); const rq=tx.objectStore(STORE).clear(); rq.onsuccess=()=>res(); rq.onerror=()=>rej(rq.error); });}
    async function refreshInfo(){ try{ const n=await countRounds(); const el=document.getElementById('dbInfo'); if(el) el.textContent='BD: '+n+' rondas'; }catch(e){} }
    document.getElementById('btnSaveDB').onclick=async()=>{ try{ let R=state.current; if(!R){ const store=JSON.parse(localStorage.getItem(storageKey)||'{}'); if(store.rounds&&store.rounds.length) R=store.rounds[store.rounds.length-1]; } if(!R){ alert('No hay ronda para guardar.'); return; } if(!R.date) R.date=new Date().toISOString(); if(!R.id) R.id='RND-'+Date.now(); await putRound(R); await refreshInfo(); alert('Ronda guardada en BD.'); }catch(e){ alert('Error al guardar en BD: '+(e&&e.message?e.message:e)); } };
    document.getElementById('btnExportDB').onclick=async()=>{ try{ const all=await getAllRounds(); const json=JSON.stringify(all,null,2); const blob=new Blob([json],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='fo_db_export_'+new Date().toISOString().slice(0,10)+'.json'; a.click(); URL.revokeObjectURL(url); }catch(e){ alert('Error al exportar: '+(e&&e.message?e.message:e)); } };
    document.getElementById('btnClearDB').onclick=async()=>{ if(!confirm('¬øVaciar la base de datos local?')) return; try{ await clearDB(); await refreshInfo(); alert('Base de datos vaciada.'); }catch(e){ alert('Error al vaciar BD: '+(e&&e.message?e.message:e)); } };
    window.addEventListener('beforeunload', async()=>{ try{ if(state.current && state.current.shots.length>0){ let R=state.current; if(!R.date) R.date=new Date().toISOString(); if(!R.id) R.id='RND-'+Date.now(); await putRound(R);} }catch(e){} });
    refreshInfo();
  })();

  /* === Impresi√≥n === */
  document.getElementById('btnPrint').onclick=()=>{
    if (state.current){
      document.getElementById('phRonda').textContent=String(state.current.number);
      document.getElementById('phEsquema').textContent=String(state.current.esquema);
      document.getElementById('phFecha').textContent=new Date().toLocaleString();
      summary.classList.add('show'); drawHeat(state.current); drawHeatVR(state.current); drawChart(state.current);
    }
    setTimeout(()=>window.print(),50);
  };
  </script>
</body>
</html>
